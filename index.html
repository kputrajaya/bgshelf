<!DOCTYPE html>
<html>
  <head>
    <title>Board Game Shelf</title>
  </head>
  <body>
    <div x-data="bgs">
      <div>
        <input type="text" x-model="username" />
        <button @click="set">Load</button>
      </div>
      <div>
        <template x-for="item in items">
          <div>
            <img :src="item.thumbnail" />
            <h3><span x-text="item.name"></span> (<span x-text="item.year"></span>)</h3>
            <div>
              Rating: [<span x-text="item.rating"></span>] | BGG: [<span x-text="item.ratingBgg"></span>] (<span
                x-text="item.ratingBggCount"
              ></span
              >)
            </div>
            <div>
              <span x-text="item.players.min"></span> &ndash; <span x-text="item.players.max"></span> players |
              <span x-text="item.playTime.min"></span> &ndash; <span x-text="item.playTime.max"></span> mins
            </div>
            <div>
              <pre x-text="item.comment"></pre>
            </div>
          </div>
        </template>
      </div>
    </div>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.5/cdn.min.js"
      integrity="sha512-y22y4rJ9d7NGoRLII5LVwUv0BfQKf6MpATy5ebVu/fbHdtJCxBpZRHZMHJv8VYl8scWjuwZcMPzwYk4sEoyL4A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.2/axios.min.js"
      integrity="sha512-QTnb9BQkG4fBYIt9JGvYmxPpd6TBeKp6lsUrtiVQsrJ9sb33Bn9s0wMQO9qVBFbPX3xHRAsBHvXlcsrnJjExjg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/fast-xml-parser/4.0.12/fxparser.min.js"
      integrity="sha512-HGrrIN/LyGNpsITQqS0Oz+0rCFt/+2/eymCPchz/Pvx8JofaxmLfoEJNIix9R1iHEnScT+HSt8WBifDINQu89g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('bgs', () => ({
          username: '',
          items: [],
          init() {
            const params = new Proxy(new URLSearchParams(window.location.search), {
              get: (searchParams, prop) => searchParams.get(prop),
            });
            this.username = params.u || '';
            this.load();
          },
          set() {
            if (!this.username) return;

            // Set query param
            var searchParams = new URLSearchParams(window.location.search);
            searchParams.set('u', this.username);
            window.location.search = searchParams.toString();
          },
          async load() {
            if (!this.username) return;

            // Initiate constants
            const host = 'https://boardgamegeek.com/xmlapi';
            const options = { 'Content-Type': 'application/xml' };
            const parser = new XMLParser({ ignoreAttributes: false });

            // Get collection data and retry
            let resCollection = null;
            while (!resCollection) {
              resCollection = await axios.get(host + '/collection/' + this.username, options).catch(() => false);
              if (resCollection.status === 202) {
                resCollection = null;
                await new Promise((resolve) => setTimeout(resolve, 1000));
              }
            }

            // Parse collection data
            const collection = parser
              .parse(resCollection.data)
              .items.item.map((item) => ({
                id: item['@_objectid'],
                image: item.image,
                thumbnail: item.thumbnail,
                name: String(item.name['#text']),
                year: item.yearpublished,
                players: {
                  min: Math.floor(item.stats['@_minplayers']),
                  max: Math.floor(item.stats['@_maxplayers']),
                },
                playTime: {
                  min: Math.floor(item.stats['@_minplaytime']),
                  max: Math.floor(item.stats['@_maxplaytime']),
                },
                rating: Math.floor(item.stats.rating['@_value']),
                ratingBgg: Math.round(parseFloat(item.stats.rating.average['@_value']) * 100) / 100,
                ratingBggCount:
                  item.stats.rating.usersrated['@_value'].length > 3
                    ? Math.round(Math.floor(item.stats.rating.usersrated['@_value']) / 1000) + 'k'
                    : item.stats.rating.usersrated['@_value'],
                comment: item.comment,
                owned: item.status['@_own'] == '1',
              }))
              .filter((item) => item.owned);

            // Sort by rating then name
            collection.sort((a, b) => b.rating - a.rating || a.name.localeCompare(b.name));

            this.items = collection;
          },
        }));
      });
    </script>
  </body>
</html>
